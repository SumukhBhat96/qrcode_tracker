<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QR Code Tracker — Card View</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
        --bg: #071617;
        --panel: #0b1616;
        --muted: #92a3ad;
        --accent: #18a08d;
        --card-radius: 12px;
        --thumb-size: 108px;
        --gap: 20px;
        --header-h: 76px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: linear-gradient(180deg, #061213 0%, #071617 120%);
        color: #eaf6ff;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-y: auto;
      }

      /* ===== fixed header ===== */
      header.app-header {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        height: var(--header-h);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 12px 18px;
        background: linear-gradient(90deg, #0b3b36 0%, #0e4b45 60%);
        z-index: 9998;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
        font-size: 18px;
        color: #eefcff;
      }
      .brand-logo {
        width: 46px;
        height: 46px;
        border-radius: 10px;
        background: #e8fff9;
        color: #0c6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      /* sort control (icon only) */
      .sort-btn {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.03);
        height: 44px;
        padding: 0 10px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: var(--muted);
      }
      .sort-btn svg {
        width: 18px;
        height: 18px;
        display: block;
      }
      /* search (desktop) */
      .search-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.02);
        padding: 8px 12px;
        border-radius: 14px;
        width: 560px;
        max-width: calc(100vw - 340px);
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      .search-wrap input {
        flex: 1;
        background: transparent;
        border: 0;
        outline: 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
      }
      .search-icon {
        opacity: 0.85;
      }
      .clear-btn {
        background: transparent;
        border: 0;
        color: var(--muted);
        cursor: pointer;
      }

      /* content wrapper offset for fixed header */
      main {
        padding-top: calc(var(--header-h) + 18px);
        max-width: 1200px;
        margin: 0 auto;
        padding-left: 18px;
        padding-right: 18px;
        transition: padding-top 0.2s;
      }
      .controls-mobile {
        display: none;
      }

      /* grid layout - 2 columns on wide screens as requested */
      .grid {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(2, 1fr);
        align-items: start;
        scroll-behavior: smooth;
        padding-bottom: 120px;
      }
      @media (max-width: 1100px) {
        .grid {
          grid-template-columns: repeat(2, minmax(260px, 1fr));
        }
      }
      @media (max-width: 760px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: var(--card-radius);
        padding: 16px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        gap: 14px;
        min-height: 280px;
        transition: transform 0.22s ease, box-shadow 0.22s;
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 28px 80px rgba(0, 0, 0, 0.65);
      }

      .card-head {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .meta {
        flex: 1;
      }
      .invoice {
        font-weight: 800;
        font-size: 18px;
      }
      .small-meta {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
        display: flex;
        gap: 18px;
      }
      .small-meta .meta-item {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 13px;
        color: var(--muted);
      }

      .card-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        flex-wrap: wrap;
      }
      .label {
        color: var(--muted);
        flex: 0 0 120px;
        font-size: 14px;
      }
      .value {
        flex: 1;
      }

      .chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        background: rgba(255, 255, 255, 0.03);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        color: #eaf6ff;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }

      /* thumbs grid: 7 slots max, responsive auto-flow */
      .thumbs {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(3, minmax(var(--thumb-size), 1fr));
      }
      @media (max-width: 760px) {
        .thumbs {
          grid-template-columns: repeat(3, minmax(72px, 1fr));
        }
      }
      .thumb {
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.02)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 1/1;
        min-height: var(--thumb-size);
        border: 1px solid rgba(255, 255, 255, 0.02);
        position: relative;
        cursor: pointer;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .thumb .fallback {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 14px;
        background: rgba(0, 0, 0, 0.2);
      }

      /* modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        padding: 16px;
      }
      .modal {
        background: #071718;
        padding: 14px;
        border-radius: 12px;
        max-width: 900px;
        width: 100%;
        max-height: 88vh;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      .modal img {
        width: 100%;
        height: auto;
        border-radius: 10px;
      }

      /* Loader overlay (shown at page start) */
      .loader-backdrop {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        background: linear-gradient(
          180deg,
          rgba(2, 6, 7, 0.98),
          rgba(2, 6, 7, 0.98)
        );
        flex-direction: column;
        gap: 18px;
      }
      .qr-loader {
        width: 110px;
        height: 110px;
        border-radius: 18px;
        background: linear-gradient(180deg, #0f3b35, #083d35);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
        position: relative;
      }
      /* small animated squares inside mimic a qr anim */
      .qr-grid {
        display: grid;
        grid-template-columns: repeat(3, 18px);
        grid-gap: 6px;
      }
      .qr-grid .cell {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background: #143e36;
        opacity: 0.12;
        transform: scale(0.9);
        animation: blink 1100ms infinite ease-in-out;
      }
      .qr-grid .cell:nth-child(1) {
        animation-delay: 0ms;
      }
      .qr-grid .cell:nth-child(2) {
        animation-delay: 80ms;
      }
      .qr-grid .cell:nth-child(3) {
        animation-delay: 160ms;
      }
      .qr-grid .cell:nth-child(4) {
        animation-delay: 240ms;
      }
      .qr-grid .cell:nth-child(5) {
        animation-delay: 320ms;
      }
      .qr-grid .cell:nth-child(6) {
        animation-delay: 400ms;
      }
      .qr-grid .cell:nth-child(7) {
        animation-delay: 480ms;
      }
      .qr-grid .cell:nth-child(8) {
        animation-delay: 560ms;
      }
      .qr-grid .cell:nth-child(9) {
        animation-delay: 640ms;
      }
      @keyframes blink {
        0%,
        100% {
          opacity: 0.12;
          transform: scale(0.9);
        }
        50% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .loader-text {
        color: var(--muted);
        font-size: 14px;
      }
      /* ensure swal toasts appear above header */
      .swal2-container {
        z-index: 11000 !important;
      }

      /* small device tweaks: search below header & carrot to right */
      @media (max-width: 720px) {
        .search-wrap {
          width: 100%;
          max-width: none;
          display: block;
          padding: 10px 12px;
          border-radius: 14px;
        }
        header.app-header {
          flex-direction: row;
          align-items: center;
          gap: 10px;
        }
        .controls-mobile {
          display: flex;
          flex-direction: column;
          gap: 8px;
          width: 100%;
        }
        .header-actions {
          order: 3;
        }
        .header-left {
          flex: 1;
        }
        /* move search below header: we will show mobile search area */
        .search-desktop {
          display: none;
        }
        .search-mobile {
          display: block;
          margin-top: calc(var(--header-h) + 8px);
          padding: 0 18px;
        }
        main {
          padding-top: calc(var(--header-h) + 66px);
        }
        .sort-btn {
          height: 44px;
        }
      }
      @media (min-width: 721px) {
        .search-mobile {
          display: none;
        }
      }

      /* tiny helpers */
      .sr-only {
        position: absolute;
        left: -9999px;
      }
    </style>
  </head>
  <body>
    <!-- Loader overlay shown at start -->
    <div id="loader" class="loader-backdrop" aria-hidden="false">
      <div class="qr-loader" aria-hidden="true">
        <div class="qr-grid" aria-hidden="true">
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
          <div class="cell"></div>
        </div>
      </div>
      <div class="loader-text">Tracking your QR — preparing dashboard…</div>
    </div>

    <header class="app-header" role="banner">
      <div class="header-left">
        <div class="brand" aria-label="QR Code Tracker">
          <div class="brand-logo">QR</div>
          <div>QR Code Tracker</div>
        </div>
        <div style="width: 8px"></div>
        <!-- sort button (icon only) -->
        <button
          id="sortBtn"
          class="sort-btn"
          title="Toggle sort (newest/oldest)"
        >
          <svg
            id="sortIcon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path
              d="M7 11l5-5 5 5M7 19l5-5 5 5"
              stroke-width="1.6"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>

      <div class="header-actions">
        <div
          class="search-wrap search-desktop"
          title="Search (invoice, location, date or month)"
        >
          <svg
            class="search-icon"
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
          >
            <path
              d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"
              stroke-width="1.4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <input
            id="searchInput"
            placeholder="Search invoice, location, date, month (jan / january) or batch..."
            aria-label="Search"
          />
          <button
            id="clearSearch"
            class="clear-btn"
            title="Clear search"
            aria-label="Clear search"
            style="display: none"
          >
            ✕
          </button>
        </div>
      </div>
    </header>

    <!-- mobile search below header -->
    <div class="search-mobile" style="display: none">
      <div style="max-width: 1200px; margin: 0 auto; padding: 0 18px">
        <div class="search-wrap">
          <svg
            class="search-icon"
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
          >
            <path
              d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"
              stroke-width="1.4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <input
            id="searchInputMobile"
            placeholder="Search invoice, location, date, month (jan / january) or batch..."
            aria-label="Search mobile"
          />
          <button
            id="clearSearchMobile"
            class="clear-btn"
            title="Clear search"
            style="display: none"
          >
            ✕
          </button>
        </div>
      </div>
    </div>

    <main>
      <section id="grid" class="grid" aria-live="polite"></section>
    </main>

    <!-- modal for image/links -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
          "
        >
          <div id="modalTitle" style="font-weight: 800"></div>
          <button
            id="modalClose"
            style="
              background: transparent;
              border: 1px solid rgba(255, 255, 255, 0.06);
              padding: 8px 10px;
              border-radius: 8px;
              color: #e6eef8;
              cursor: pointer;
            "
          >
            Close
          </button>
        </div>
        <img id="modalImage" src="" alt="QR large view" />
        <div
          id="modalLinks"
          style="
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
          "
        ></div>
      </div>
    </div>

    <script>
      /* ===== config ===== */
      const LOADER_MS = 4500; // loader visible duration (ms)
      const QR_PLACEHOLDER_SVG = encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'>
    <rect width='100%' height='100%' fill='#0b1416'/>
    <g fill='#9bd7c9'>
      <rect x='26' y='26' width='90' height='90' rx='12'/>
      <rect x='284' y='26' width='90' height='90' rx='12'/>
      <rect x='26' y='284' width='90' height='90' rx='12'/>
      <!-- some squares to mimic small qr -->
      <rect x='150' y='150' width='20' height='20'/>
      <rect x='176' y='150' width='12' height='12'/>
      <rect x='160' y='176' width='10' height='10'/>
      <rect x='200' y='160' width='12' height='12'/>
      <rect x='224' y='180' width='10' height='10'/>
    </g>
  </svg>`
      );
      const QR_PLACEHOLDER = `data:image/svg+xml;utf8,${QR_PLACEHOLDER_SVG}`;

      /* ===== demo card data (each card will have 7 slots by default) =====
   When you want to change images later, edit the qrImages array entries.
*/
      let cards = [
        {
          id: 101,
          invoice: "INV-1001",
          date: "2025-11-10",
          location: "Mumbai Port",
          status: "completed",
          batches: ["MB-211", "MB-212", "MB-300A"],
          qrImages: [],
        },
        {
          id: 102,
          invoice: "INV-1023",
          date: "2025-11-18",
          location: "Nhava Sheva",
          status: "pending",
          batches: ["MB-900"],
          qrImages: [],
        },
        {
          id: 103,
          invoice: "INV-1029",
          date: "2025-11-21",
          location: "Tuticorin",
          status: "completed",
          batches: ["MB-111", "MB-112", "MB-113", "MB-114"],
          qrImages: [],
        },
        {
          id: 104,
          invoice: "INV-1035",
          date: "2025-12-02",
          location: "Mumbai Port",
          status: "pending",
          batches: ["MB-601", "MB-602"],
          qrImages: [],
        },
        {
          id: 105,
          invoice: "INV-1040",
          date: "2025-11-23",
          location: "Kolkata Port",
          status: "completed",
          batches: ["MB-301", "MB-302"],
          qrImages: [],
        },
        {
          id: 106,
          invoice: "INV-1045",
          date: "2025-11-24",
          location: "Cochin Port",
          status: "pending",
          batches: ["MB-401", "MB-402", "MB-403"],
          qrImages: [],
        },
      ];

      // Add 6 more cards on request — keep structure consistent and give each 7 placeholders
      for (let i = 107; i <= 112; i++) {
        cards.push({
          id: i,
          invoice: `INV-${1000 + i}`,
          date: randomDateString(),
          location: [
            "Mumbai Port",
            "Kandla",
            "Tuticorin",
            "Nhava Sheva",
            "Cochin Port",
          ][i % 5],
          status: i % 2 === 0 ? "completed" : "pending",
          batches: [`MB-${100 + i}`, `MB-${110 + i}`].slice(0, (i % 3) + 1),
          qrImages: [
            /* filled below */
          ],
        });
      }

      // Helper to populate each card with 7 placeholder QR images (can be replaced by real local URLs)
      cards = cards.map((c) => {
        // ensure exactly 7 slots; if you want fewer in future, set shorter array
        const imgs = [];
        for (let k = 0; k < 7; k++) {
          imgs.push({ url: QR_PLACEHOLDER, links: [] });
        }
        return { ...c, qrImages: imgs };
      });

      /* utility: random date generator for demo cards (2025-11..2026-03) */
      function randomDateString() {
        const start = new Date(2025, 10, 1).getTime();
        const end = new Date(2026, 2, 28).getTime();
        const d = new Date(start + Math.random() * (end - start));
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
          2,
          "0"
        )}-${String(d.getDate()).padStart(2, "0")}`;
      }

      /* sort state (true => newest first) */
      let newestFirst = true;

      /* cached DOM */
      const grid = document.getElementById("grid");
      const loader = document.getElementById("loader");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalImage = document.getElementById("modalImage");
      const modalLinks = document.getElementById("modalLinks");
      const modalTitle = document.getElementById("modalTitle");

      const searchInput = document.getElementById("searchInput");
      const clearSearch = document.getElementById("clearSearch");
      const searchInputMobile = document.getElementById("searchInputMobile");
      const clearSearchMobile = document.getElementById("clearSearchMobile");
      const sortBtn = document.getElementById("sortBtn");
      const sortIcon = document.getElementById("sortIcon");

      /* month maps for search */
      const monthMap = {
        jan: 1,
        january: 1,
        feb: 2,
        february: 2,
        mar: 3,
        march: 3,
        apr: 4,
        april: 4,
        may: 5,
        jun: 6,
        june: 6,
        jul: 7,
        july: 7,
        aug: 8,
        august: 8,
        sep: 9,
        sept: 9,
        september: 9,
        oct: 10,
        october: 10,
        nov: 11,
        november: 11,
        dec: 12,
        december: 12,
      };

      /* show loader then render content */
      window.addEventListener("load", () => {
        // show loader for LOADER_MS then render
        setTimeout(() => {
          loader.style.display = "none";
          renderSortedAndFiltered();
          // show mobile search area if narrow
          if (window.innerWidth <= 720)
            document.querySelector(".search-mobile").style.display = "block";
        }, LOADER_MS);
      });

      /* Sorting toggle */
      sortBtn.addEventListener("click", () => {
        newestFirst = !newestFirst;
        // rotate icon slightly to convey direction (simple visual)
        sortIcon.style.transform = newestFirst
          ? "rotate(0deg)"
          : "rotate(180deg)";
        renderSortedAndFiltered();
      });

      /* Search handlers */
      function setClearVisibility(inputEl, clearBtn) {
        if (inputEl.value && inputEl.value.trim() !== "")
          clearBtn.style.display = "inline";
        else clearBtn.style.display = "none";
      }
      searchInput.addEventListener("input", () => {
        setClearVisibility(searchInput, clearSearch);
        renderSortedAndFiltered();
      });
      clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        setClearVisibility(searchInput, clearSearch);
        renderSortedAndFiltered();
      });

      searchInputMobile.addEventListener("input", () => {
        setClearVisibility(searchInputMobile, clearSearchMobile);
        renderSortedAndFiltered();
      });
      clearSearchMobile.addEventListener("click", () => {
        searchInputMobile.value = "";
        setClearVisibility(searchInputMobile, clearSearchMobile);
        renderSortedAndFiltered();
      });

      /* Helper: parse query -> filter cards */
      function matchesCard(card, q) {
        if (!q) return true;
        q = q.trim().toLowerCase();
        // Invoice
        if (card.invoice && card.invoice.toLowerCase().includes(q)) return true;
        // location
        if (card.location && card.location.toLowerCase().includes(q))
          return true;
        // batch codes
        if (
          card.batches &&
          card.batches.some((b) => b.toLowerCase().includes(q))
        )
          return true;
        // direct date match (yyyy-mm-dd)
        if (card.date && card.date.toLowerCase().includes(q)) return true;
        // month words: if the query is a month word (jan / feb / january)
        const qclean = q.replace(/\./g, "");
        if (monthMap[qclean]) {
          const mon = monthMap[qclean];
          // card.date like YYYY-MM-DD; extract month
          const dparts = card.date.split("-");
          if (dparts[1] && Number(dparts[1]) === mon) return true;
        }
        // also allow "jan 2025" or "nov 2025" (look for month name inside date or card fields)
        const monthNames = Object.keys(monthMap);
        for (const name of monthNames) {
          if (q.includes(name)) {
            // test
            const mon = monthMap[name];
            const dparts = card.date.split("-");
            if (dparts[1] && Number(dparts[1]) === mon) return true;
          }
        }
        return false;
      }

      /* render with current sort and filter */
      function renderSortedAndFiltered() {
        const q = (
          window.innerWidth <= 720
            ? searchInputMobile.value || ""
            : searchInput.value || ""
        ).trim();
        // sort by date
        const sorted = [...cards].sort((a, b) => {
          const da = new Date(a.date).getTime();
          const db = new Date(b.date).getTime();
          return newestFirst ? db - da : da - db;
        });
        // filter by search
        const filtered = sorted.filter((c) => matchesCard(c, q.toLowerCase()));
        renderGrid(filtered);
      }

      /* render cards into grid */
      function renderGrid(list) {
        grid.innerHTML = "";
        list.forEach((card) => {
          const article = document.createElement("article");
          article.className = "card";
          article.innerHTML = `
      <div class="card-head">
        <div class="brand-logo" aria-hidden="true">QR</div>
        <div class="meta">
          <div class="invoice">Shipment ${card.invoice}</div>
          <div class="small-meta">
            <div class="meta-item"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M7 11l5-5 5 5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><div style="font-weight:700">${
              card.date
            }</div></div>
            <div class="meta-item"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 21s7-4.5 7-10a7 7 0 10-14 0c0 5.5 7 10 7 10z" stroke="currentColor" stroke-width="1.2"/></svg><div style="font-weight:700">${
              card.location
            }</div></div>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="row"><div class="label">Status</div><div class="value"><div class="pill ${
          card.status === "completed" ? "done" : "pending"
        }" style="display:inline-block;padding:8px 16px;border-radius:28px;background:${
            card.status === "completed"
              ? "linear-gradient(180deg,#16a34a,#0ea25a)"
              : "linear-gradient(180deg,#ef4444,#ef6b6b)"
          };font-weight:700;color:#fff">${
            card.status === "completed" ? "Completed" : "Pending"
          }</div></div></div>

        <div class="row"><div class="label">Material Batch</div><div class="value chips">${(
          card.batches || []
        )
          .map((b) => `<span class="chip">${b}</span>`)
          .join("")}</div></div>

        <div class="row">
          <div class="label">QR Code(s)</div>
          <div class="value thumbs" id="thumbs-${card.id}"></div>
        </div>
      </div>
    `;
          grid.appendChild(article);

          // populate thumbs (exactly 7 slots; card.qrImages may be any length, but we enforce 7 visual slots)
          const thumbsEl = article.querySelector(`#thumbs-${card.id}`);
          const slots = 7;
          for (let i = 0; i < slots; i++) {
            const imgObj =
              card.qrImages && card.qrImages[i] ? card.qrImages[i] : null;
            const thumb = document.createElement("div");
            thumb.className = "thumb";
            thumb.dataset.card = card.id;
            thumb.dataset.index = i;
            if (imgObj && imgObj.url) {
              const img = document.createElement("img");
              img.src = imgObj.url;
              img.alt = `qr-${card.id}-${i}`;
              img.loading = "lazy";
              img.onerror = function () {
                this.style.display = "none";
                const f = this.parentElement.querySelector(".fallback");
                if (f) f.style.display = "flex";
              };
              thumb.appendChild(img);
            } else {
              // no image: show fallback
              const f = document.createElement("div");
              f.className = "fallback";
              f.textContent = "No image";
              thumb.appendChild(f);
            }
            thumbsEl.appendChild(thumb);

            // click opens modal only if image exists
            thumb.addEventListener("click", () => {
              if (imgObj && imgObj.url) {
                openModal(card.id, i);
              } else {
                // toast
                Swal.fire({
                  toast: true,
                  position: "top-end",
                  icon: "info",
                  title: "Image not available",
                  showConfirmButton: false,
                  timer: 1200,
                  background: "#0b1717",
                });
              }
            });
          }
        });

        // ensure grid top padding prevents header overlap
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      /* modal open/close */
      document
        .getElementById("modalClose")
        .addEventListener("click", closeModal);
      function openModal(cardId, idx) {
        const card = cards.find((c) => c.id == cardId);
        if (!card) return;
        const imgObj = card.qrImages[idx];
        if (!imgObj) return;
        modalImage.src = imgObj.url;
        modalTitle.textContent = `${card.invoice} — QR ${idx + 1}`;
        modalLinks.innerHTML = "";
        (imgObj.links || []).forEach((l) => {
          const r = document.createElement("div");
          r.style.width = "100%";
          r.style.maxWidth = "760px";
          r.style.background = "rgba(255,255,255,0.02)";
          r.style.padding = "8px 12px";
          r.style.borderRadius = "8px";
          r.innerHTML = `<a href="${l}" target="_blank" style="color:var(--accent);text-decoration:underline">${l}</a> <button class="copy" data-link="${l}" style="float:right;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eef8;padding:6px 8px;border-radius:6px;cursor:pointer">Copy</button>`;
          modalLinks.appendChild(r);
        });
        if ((imgObj.links || []).length === 0) {
          const d = document.createElement("div");
          d.style.color = "var(--muted)";
          d.textContent = "No links attached";
          modalLinks.appendChild(d);
        } else {
          modalLinks.querySelectorAll(".copy").forEach((b) =>
            b.addEventListener("click", (ev) => {
              const l = b.getAttribute("data-link");
              navigator.clipboard
                .writeText(l)
                .then(() =>
                  Swal.fire({
                    toast: true,
                    position: "top-end",
                    icon: "success",
                    title: "Copied",
                    showConfirmButton: false,
                    timer: 900,
                  })
                );
            })
          );
        }
        modalBackdrop.style.display = "flex";
        modalBackdrop.setAttribute("aria-hidden", "false");
      }
      function closeModal() {
        modalBackdrop.style.display = "none";
        modalBackdrop.setAttribute("aria-hidden", "true");
        modalImage.src = "";
        modalLinks.innerHTML = "";
      }

      /* ensure toast above header */
      const style = document.createElement("style");
      style.innerHTML = `.swal2-container{z-index:12000 !important}`;
      document.head.appendChild(style);

      /* keyboard close modal */
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalBackdrop.style.display === "flex")
          closeModal();
      });

      /* responsive: show mobile search under header if needed */
      function handleResponsive() {
        if (window.innerWidth <= 720) {
          document.querySelector(".search-mobile").style.display = "block";
          // sync values
          searchInputMobile.value = searchInput.value;
          setClearVisibility(searchInputMobile, clearSearchMobile);
        } else {
          document.querySelector(".search-mobile").style.display = "none";
        }
      }
      window.addEventListener("resize", handleResponsive);

      /* initial small delay to make sure grid doesn't jump under header */
      document.addEventListener("DOMContentLoaded", () => {
        handleResponsive();
      });
    </script>
  </body>
</html>
