<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QR Code Tracker</title>
    <!-- SweetAlert2 (toasts) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
        --bg1: #061314;
        --bg2: #0b1717;
        --muted: #9aa7b2;
        --accent: #24c1a0;
        --accent2: #22a6ff;
        --card-radius: 14px;
        --thumb-size: 120px;
        --gap: 20px;
        --header-h: 72px;
        --loader-z: 1600;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
        -webkit-font-smoothing: antialiased;
        color: #eaf6ff;
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        scroll-behavior: smooth;
        overflow-x: hidden;
      }

      /* ensure SweetAlert toasts appear above header */
      .swal2-container {
        z-index: 1700 !important;
      }

      /* header */
      header.app-header {
        position: sticky;
        top: 0;
        z-index: 1200;
        height: var(--header-h);
        display: flex;
        align-items: center;
        background: linear-gradient(90deg, #08363b, #0b2f2f);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        padding: 10px 18px;
      }
      .header-inner {
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 0 0 auto;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: #e7fbf5;
        color: #0a6b5c;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
      }
      .brand h1 {
        margin: 0;
        font-size: 18px;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 8px;
      }
      .sort-wrap {
        display: flex;
        align-items: center;
        padding: 6px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.02);
      }
      .sort-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: none;
        background: transparent;
        color: #dff6ff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sort-btn.active {
        background: rgba(255, 255, 255, 0.03);
      }

      /* search */
      .search-wrap {
        margin-left: auto;
        flex: 1 1 auto;
        max-width: 760px;
        display: flex;
        align-items: center;
      }
      .search {
        position: relative;
        width: 100%;
      }
      .search input {
        width: 100%;
        padding: 12px 44px 12px 44px;
        border-radius: 28px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: #dfeefc;
        font-size: 14px;
      }
      .search .icon-left {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
      }
      .search .clear-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
      }
      .search .clear-btn.hidden {
        display: none;
      }

      /* main content spacing */
      main.content {
        max-width: 1200px;
        margin: 12px auto 80px;
        padding: calc(var(--header-h) + 12px) 18px 40px;
      }

      /* grid responsive: mobile 1 column, tablet 2, large 3 */
      .grid {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(1, 1fr);
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (min-width: 1300px) {
        .grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: var(--card-radius);
        padding: 18px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow: 0 10px 36px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: transform 0.22s, box-shadow 0.22s;
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 26px 72px rgba(0, 0, 0, 0.6);
      }

      .card-head {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .title-block {
        flex: 1;
      }
      .title {
        font-weight: 800;
        font-size: 18px;
        margin: 0 0 6px 0;
      }
      .meta-row {
        display: flex;
        gap: 14px;
        align-items: center;
        flex-wrap: wrap;
      }
      .meta-item {
        display: flex;
        gap: 10px;
        align-items: center;
        color: var(--muted);
        font-size: 13px;
      }
      .meta-strong {
        font-weight: 800;
        color: #eaf6ff;
        font-size: 14px;
      }

      .card-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .label {
        color: var(--muted);
        width: 140px;
        flex: 0 0 140px;
        font-size: 14px;
      }
      @media (max-width: 640px) {
        .label {
          width: 110px;
          flex-basis: 110px;
        }
      }
      .value {
        flex: 1;
        font-weight: 700;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .chip {
        background: rgba(255, 255, 255, 0.02);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        color: #dfeefc;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }

      /* thumbs grid - uses CSS fallback; JS adjusts columns too */
      .thumbs {
        display: grid;
        gap: 12px;
        align-content: start;
        grid-template-columns: repeat(auto-fit, minmax(var(--thumb-size), 1fr));
      }
      .thumb {
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.02)
        );
        display: block;
        aspect-ratio: 1/1;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
        cursor: pointer;
        position: relative;
        border: 2px solid rgba(255, 255, 255, 0.02);
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .thumb .fallback {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        color: var(--muted);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.35),
          rgba(0, 0, 0, 0.35)
        );
        border-radius: 8px;
      }

      /* pill */
      .pill {
        padding: 8px 18px;
        border-radius: 999px;
        font-weight: 800;
        color: white;
        display: inline-block;
      }
      .pill.done {
        background: linear-gradient(180deg, #16a34a, #0ea25a);
      }
      .pill.pending {
        background: linear-gradient(180deg, #ef4444, #ef6b6b);
      }

      /* modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1300;
        padding: 18px;
      }
      .modal {
        background: linear-gradient(180deg, #071618, #0a1718);
        border-radius: 12px;
        padding: 16px;
        max-width: 920px;
        width: 100%;
        max-height: 92vh;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .modal-img {
        width: 100%;
        height: auto;
        max-height: 72vh;
        object-fit: contain;
        border-radius: 8px;
      }
      .links-list {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      .link-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.02);
        padding: 10px 14px;
        border-radius: 10px;
        width: 100%;
      }
      .link-row a {
        color: var(--accent2);
        text-decoration: underline;
        word-break: break-all;
      }

      /* NEW loader (full-screen) */
      .loader-wrap {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: var(--loader-z);
        pointer-events: auto;
        background: linear-gradient(
          180deg,
          rgba(2, 10, 10, 0.7),
          rgba(2, 10, 10, 0.9)
        );
      }
      .loader-card {
        pointer-events: auto;
        padding: 22px;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        display: flex;
        gap: 18px;
        align-items: center;
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.6);
      }
      .qr-anim {
        width: 92px;
        height: 92px;
        border-radius: 10px;
        background: #072a2a;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 6px;
        padding: 8px;
      }
      .qr-anim .sq {
        background: #0fa98e;
        border-radius: 3px;
        opacity: 0.14;
        transform: scale(0.7);
        animation: pop 0.95s infinite ease-in-out;
      }
      .qr-anim .sq:nth-child(2) {
        animation-delay: 0.08s;
      }
      .qr-anim .sq:nth-child(3) {
        animation-delay: 0.16s;
      }
      .qr-anim .sq:nth-child(4) {
        animation-delay: 0.24s;
      }
      .qr-anim .sq:nth-child(5) {
        animation-delay: 0.32s;
      }
      .qr-anim .sq:nth-child(6) {
        animation-delay: 0.4s;
      }
      .qr-anim .sq:nth-child(7) {
        animation-delay: 0.48s;
      }
      .qr-anim .sq:nth-child(8) {
        animation-delay: 0.56s;
      }
      .qr-anim .sq:nth-child(9) {
        animation-delay: 0.64s;
      }
      @keyframes pop {
        0% {
          opacity: 0.12;
          transform: scale(0.7);
        }
        50% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0.12;
          transform: scale(0.7);
        }
      }
      .loader-text {
        font-weight: 800;
        color: #e7fbf5;
        font-size: 18px;
      }
      .loader-sub {
        color: var(--muted);
        font-size: 13px;
      }

      /* small helpers */
      .icon-like {
        background: transparent;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 16px;
      }
      .muted {
        color: var(--muted);
      }

      @media (max-width: 600px) {
        :root {
          --thumb-size: 92px;
        }
        .header-inner {
          padding-right: 8px;
        }
        .brand h1 {
          font-size: 16px;
        }
        .search input {
          font-size: 13px;
        }
        .loader-card {
          padding: 12px;
        }
        .loader-text {
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header" aria-label="Top Bar">
      <div class="header-inner">
        <div class="brand" role="banner">
          <div class="logo">QR</div>
          <h1>QR Code Tracker</h1>
        </div>

        <div class="controls" role="region" aria-label="Sort control">
          <div class="sort-wrap" title="Toggle sort (newest / oldest)">
            <button id="sortToggle" class="sort-btn" aria-label="Toggle sort">
              <svg
                id="sortIcon"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
              >
                <path
                  d="M6 9l6-6 6 6M18 15l-6 6-6-6"
                  stroke="#dff6ff"
                  stroke-width="1.4"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="search-wrap">
          <div class="search" role="search">
            <span class="icon-left" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 21l-4.35-4.35"
                  stroke="#9aa7b2"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <circle
                  cx="11"
                  cy="11"
                  r="6"
                  stroke="#9aa7b2"
                  stroke-width="1.6"
                />
              </svg>
            </span>
            <input
              id="searchInput"
              placeholder="Search invoice, location, date, month (jan / january) or batch..."
              aria-label="Search"
            />
            <button
              id="clearBtn"
              class="clear-btn hidden"
              title="Clear search"
              aria-label="Clear search"
            >
              ✕
            </button>
          </div>
        </div>
      </div>
    </header>

    <main
      class="content"
      id="mainContent"
      aria-live="polite"
      style="
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.28s, visibility 0.28s;
      "
    >
      <div id="grid" class="grid"></div>
    </main>

    <!-- modal -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <div style="font-weight: 800; color: #eaf6ff" id="modalTitle">QR</div>
          <div>
            <button id="modalClose" class="icon-like" aria-label="Close modal">
              Close
            </button>
          </div>
        </div>
        <img id="modalImage" class="modal-img" src="" alt="QR large" />
        <div id="modalLinks" class="links-list"></div>
      </div>
    </div>

    <!-- loader (full-screen) -->
    <div id="loaderWrap" class="loader-wrap" aria-hidden="false">
      <div class="loader-card" role="status" aria-live="polite">
        <div class="qr-anim" aria-hidden="true">
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
          <div class="sq"></div>
        </div>
        <div>
          <div class="loader-text">Scanning QR</div>
          <div class="loader-sub">Tracking your QR — preparing view…</div>
        </div>
      </div>
    </div>

    <script>
      /* ===== CONFIG ===== */
      const LOADER_MS = 4500; // loader duration in ms
      const grid = document.getElementById("grid");
      const searchInput = document.getElementById("searchInput");
      const clearBtn = document.getElementById("clearBtn");
      const loaderWrap = document.getElementById("loaderWrap");
      const mainContent = document.getElementById("mainContent");
      const monthMap = {
        jan: "01",
        january: "01",
        feb: "02",
        february: "02",
        mar: "03",
        march: "03",
        apr: "04",
        april: "04",
        may: "05",
        jun: "06",
        june: "06",
        jul: "07",
        july: "07",
        aug: "08",
        august: "08",
        sep: "09",
        sept: "09",
        september: "09",
        oct: "10",
        october: "10",
        nov: "11",
        november: "11",
        dec: "12",
        december: "12",
      };

      /* create an inline QR-looking SVG as placeholder (we will encode at runtime) */
      const qrSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <rect width='100' height='100' fill='#0b1717'/>
  <rect x='6' y='6' width='28' height='28' fill='#fff'/>
  <rect x='10' y='10' width='20' height='20' fill='#0b1717'/>
  <rect x='64' y='6' width='28' height='28' fill='#fff'/>
  <rect x='68' y='10' width='20' height='20' fill='#0b1717'/>
  <rect x='6' y='64' width='28' height='28' fill='#fff'/>
  <rect x='10' y='68' width='20' height='20' fill='#0b1717'/>
  <!-- some inner squares -->
  <rect x='40' y='42' width='8' height='8' fill='#fff'/>
  <rect x='52' y='52' width='6' height='6' fill='#fff'/>
</svg>`;
      const PLACEHOLDER_QR =
        "data:image/svg+xml;utf8," + encodeURIComponent(qrSvg);

      /* ===== sample cards (with many entries) ===== */
      let cards = [
        {
          id: 1,
          invoice: "INV-1001",
          date: "2025-11-10",
          location: "Mumbai Port",
          status: "completed",
          batches: ["MB-211", "MB-212", "MB-300A"],
          qrImages: [{ url: PLACEHOLDER_QR }, { url: PLACEHOLDER_QR }],
        },
        {
          id: 2,
          invoice: "INV-1023",
          date: "2025-11-18",
          location: "Nhava Sheva",
          status: "pending",
          batches: ["MB-900"],
          qrImages: [],
        },
        {
          id: 3,
          invoice: "INV-1029",
          date: "2025-11-21",
          location: "Tuticorin",
          status: "completed",
          batches: ["MB-111", "MB-112", "MB-113", "MB-114"],
          qrImages: [{ url: PLACEHOLDER_QR }],
        },
        {
          id: 4,
          invoice: "INV-1035",
          date: "2025-11-22",
          location: "Chennai Port",
          status: "completed",
          batches: ["MB-201"],
          qrImages: [{ url: PLACEHOLDER_QR }],
        },
        {
          id: 5,
          invoice: "INV-1040",
          date: "2025-11-23",
          location: "Kolkata Port",
          status: "completed",
          batches: ["MB-301", "MB-302"],
          qrImages: [],
        },
        {
          id: 6,
          invoice: "INV-1045",
          date: "2025-11-24",
          location: "Cochin Port",
          status: "pending",
          batches: ["MB-401", "MB-402", "MB-403"],
          qrImages: [],
        },
        {
          id: 7,
          invoice: "INV-1050",
          date: "2025-12-02",
          location: "Mumbai Port",
          status: "pending",
          batches: ["MB-601", "MB-602"],
          qrImages: [],
        },
        {
          id: 8,
          invoice: "INV-1053",
          date: "2025-12-15",
          location: "Nhava Sheva",
          status: "completed",
          batches: ["MB-651"],
          qrImages: [],
        },
        {
          id: 9,
          invoice: "INV-1055",
          date: "2026-02-02",
          location: "Tuticorin",
          status: "pending",
          batches: ["MB-700"],
          qrImages: [{ url: PLACEHOLDER_QR }],
        },
        {
          id: 10,
          invoice: "INV-1060",
          date: "2025-12-20",
          location: "Kochi Port",
          status: "completed",
          batches: ["MB-801"],
          qrImages: [],
        },
        {
          id: 11,
          invoice: "INV-1065",
          date: "2026-01-05",
          location: "Vizag Port",
          status: "pending",
          batches: ["MB-901", "MB-902"],
          qrImages: [],
        },
        {
          id: 12,
          invoice: "INV-1070",
          date: "2026-01-20",
          location: "Mormugao",
          status: "completed",
          batches: ["MB-1001"],
          qrImages: [],
        },
        {
          id: 13,
          invoice: "INV-1075",
          date: "2026-02-10",
          location: "Paradip",
          status: "pending",
          batches: ["MB-1101"],
          qrImages: [],
        },
        {
          id: 14,
          invoice: "INV-1080",
          date: "2026-02-18",
          location: "Ennore",
          status: "completed",
          batches: ["MB-1201"],
          qrImages: [],
        },
        {
          id: 15,
          invoice: "INV-1085",
          date: "2026-03-01",
          location: "Kandla",
          status: "pending",
          batches: ["MB-1301"],
          qrImages: [],
        },
      ];

      /* ensure exactly 7 slots per card (fills with QR placeholder) */
      function ensureSevenImages() {
        cards.forEach((c) => {
          c.qrImages = Array.isArray(c.qrImages) ? c.qrImages.slice() : [];
          while (c.qrImages.length < 7) {
            c.qrImages.push({ url: PLACEHOLDER_QR, links: [] });
          }
        });
      }

      /* sorting + search */
      let sortNewestFirst = true;
      function sortCardsList() {
        cards.sort((a, b) => {
          const da = new Date(a.date + "T00:00:00"),
            db = new Date(b.date + "T00:00:00");
          if (isNaN(da) || isNaN(db)) return 0;
          return sortNewestFirst ? db - da : da - db;
        });
      }

      function render() {
        sortCardsList();
        const q = (searchInput.value || "").trim().toLowerCase();
        grid.innerHTML = "";
        const filtered = cards.filter((c) => {
          if (!q) return true;
          const invoice = (c.invoice || "").toLowerCase();
          const loc = (c.location || "").toLowerCase();
          const batches = (c.batches || []).join(" ").toLowerCase();
          const date = (c.date || "").toLowerCase();
          const monNorm = monthMap[q] || null;
          let monthMatches = false;
          if (monNorm && c.date) {
            const cardMon = (c.date || "").slice(5, 7);
            monthMatches = cardMon === monNorm;
          }
          return (
            invoice.includes(q) ||
            loc.includes(q) ||
            batches.includes(q) ||
            date.includes(q) ||
            monthMatches
          );
        });

        filtered.forEach((c) => {
          const thumbsId = "thumbs-" + c.id;
          const el = document.createElement("article");
          el.className = "card";
          el.innerHTML = `
      <div class="card-head">
        <div class="logo" aria-hidden="true" style="width:44px;height:44px;border-radius:10px;background:#e7fbf5;color:#0a6b5c;display:flex;align-items:center;justify-content:center;font-weight:800">QR</div>
        <div class="title-block">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="color:var(--muted);font-size:13px;margin-bottom:4px">Shipment Invoice#</div>
              <div class="title">${c.invoice}</div>
            </div>
          </div>
          <div class="meta-row" style="margin-top:8px">
            <div class="meta-item"><svg class="icon-small" viewBox="0 0 24 24" width="16" height="16"><path d="M8 7V3M16 7V3M3 11h18M5 21h14a1 1 0 001-1V7a1 1 0 00-1-1H5a1 1 0 00-1 1v13a1 1 0 001 1z" stroke="#9aa7b2" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <div style="display:flex;flex-direction:column;margin-left:6px"><div class="meta-strong">${
                c.date
              }</div><div class="muted" style="font-size:12px">Container date</div></div></div>

            <div class="meta-item"><svg class="icon-small" viewBox="0 0 24 24" width="16" height="16"><path d="M12 21s7-4.5 7-10a7 7 0 10-14 0c0 5.5 7 10 7 10z" stroke="#9aa7b2" stroke-width="1.2" fill="none"/></svg>
              <div style="display:flex;flex-direction:column;margin-left:6px"><div class="meta-strong">${
                c.location
              }</div><div class="muted" style="font-size:12px">Port</div></div></div>

          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="row"><div class="label">Status</div><div class="value"><div class="pill ${
          c.status === "completed" ? "done" : "pending"
        }">${
            c.status === "completed" ? "Completed" : "Pending"
          }</div></div></div>
        <div class="row"><div class="label">Material Batch</div><div class="value chips">${(
          c.batches || []
        )
          .map((b) => `<span class="chip">${b}</span>`)
          .join("")}</div></div>
        <div class="row"><div class="label">QR Code(s)</div><div class="value"><div id="${thumbsId}" class="thumbs">
          ${(c.qrImages || [])
            .map(
              (img, idx) =>
                `<div class="thumb" data-card="${
                  c.id
                }" data-index="${idx}" title="Open QR ${idx + 1}"><img src="${
                  img.url
                }" alt="qr-${
                  c.id
                }-${idx}" loading="lazy" onerror="handleBrokenImage(this)"/><div class="fallback">Image not found</div></div>`
            )
            .join("")}
        </div></div></div>
      </div>
    `;
          grid.appendChild(el);

          const thumbsEl = document.getElementById(thumbsId);
          if (thumbsEl) {
            const count = (c.qrImages || []).length || 0;
            let cols = 3;
            if (count <= 1) cols = 1;
            else if (count === 2) cols = 2;
            else cols = 3;
            thumbsEl.style.gridTemplateColumns = `repeat(${cols}, minmax(90px, 1fr))`;
          }
        });

        attachThumbHandlers();
      }

      /* broken image fallback */
      function handleBrokenImage(img) {
        try {
          img.style.display = "none";
          const parent = img.closest(".thumb");
          if (parent) {
            const fallback = parent.querySelector(".fallback");
            if (fallback) fallback.style.display = "flex";
          }
        } catch (e) {
          console.error(e);
        }
      }

      /* modal */
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalImage = document.getElementById("modalImage");
      const modalLinks = document.getElementById("modalLinks");
      const modalTitle = document.getElementById("modalTitle");
      document
        .getElementById("modalClose")
        .addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) closeModal();
      });

      function attachThumbHandlers() {
        document.querySelectorAll(".thumb").forEach((t) => {
          t.addEventListener("click", () => {
            const cardId = Number(t.getAttribute("data-card")),
              idx = Number(t.getAttribute("data-index"));
            const card = cards.find((x) => x.id === cardId);
            if (!card) return;
            const imgObj = card.qrImages[idx];
            if (!imgObj) return;
            const imgTag = t.querySelector("img");
            if (imgTag && imgTag.style.display === "none") {
              Swal.fire({
                toast: true,
                position: "top-end",
                icon: "info",
                title: "Image not available",
                showConfirmButton: false,
                timer: 900,
              });
              return;
            }
            openModal(card, imgObj, idx);
          });
        });
      }
      function openModal(card, imgObj, idx) {
        modalTitle.textContent = `${card.invoice} — QR ${idx + 1}`;
        modalImage.src = imgObj.url;
        modalLinks.innerHTML = "";
        const links = imgObj.links || [];
        if (links.length === 0) {
          const d = document.createElement("div");
          d.textContent = "No links attached to this QR";
          d.className = "muted";
          modalLinks.appendChild(d);
        } else {
          links.forEach((l) => {
            const row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML = `<a href="${l}" target="_blank" rel="noopener noreferrer">${l}</a><button class="icon-like copy-btn" data-link="${l}">Copy</button>`;
            modalLinks.appendChild(row);
          });
          modalLinks.querySelectorAll(".copy-btn").forEach((b) =>
            b.addEventListener("click", () => {
              navigator.clipboard
                .writeText(b.dataset.link)
                .then(() =>
                  Swal.fire({
                    toast: true,
                    position: "top-end",
                    icon: "success",
                    title: "Copied",
                    showConfirmButton: false,
                    timer: 800,
                  })
                );
            })
          );
        }
        modalBackdrop.style.display = "flex";
        modalBackdrop.setAttribute("aria-hidden", "false");
      }
      function closeModal() {
        modalBackdrop.style.display = "none";
        modalBackdrop.setAttribute("aria-hidden", "true");
        modalImage.src = "";
        modalLinks.innerHTML = "";
      }

      /* search + clear */
      searchInput.addEventListener("input", () => {
        const v = searchInput.value.trim();
        clearBtn.classList.toggle("hidden", v.length === 0);
        render();
      });
      clearBtn.addEventListener("click", () => {
        searchInput.value = "";
        clearBtn.classList.add("hidden");
        render();
      });

      /* sort toggle */
      const sortToggle = document.getElementById("sortToggle");
      sortToggle.addEventListener("click", () => {
        sortNewestFirst = !sortNewestFirst;
        const icon = document.getElementById("sortIcon");
        icon.style.transform = sortNewestFirst
          ? "rotate(0deg)"
          : "rotate(180deg)";
        sortToggle.classList.add("active");
        setTimeout(() => sortToggle.classList.remove("active"), 120);
        render();
      });
      sortToggle.addEventListener("touchstart", (e) => {
        e.preventDefault();
        sortToggle.click();
      });

      /* initial flow:
   1) ensure 7 image slots
   2) show loader (already visible by default)
   3) after LOADER_MS hide loader and reveal main content and render
*/
      ensureSevenImages();
      window.addEventListener("load", () => {
        // keep loader visible then reveal after LOADER_MS
        setTimeout(() => {
          loaderWrap.style.display = "none";
          loaderWrap.setAttribute("aria-hidden", "true");
          mainContent.style.visibility = "visible";
          mainContent.style.opacity = "1";
          render();
        }, LOADER_MS);
      });

      /* accessibility */
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });
    </script>
  </body>
</html>
