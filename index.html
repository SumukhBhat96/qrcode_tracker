<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QR Code Tracker — Loader + Header update</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --bg: #061014;
        --card: #0b1415;
        --muted: #9aa7b2;
        --accent: #19b3a8;
        --accent-2: #5ccfa7;
        --card-radius: 12px;
        --gap: 22px;
        --thumb-size: 140px;
        --max-width: 1280px;
        --search-bg: rgba(255, 255, 255, 0.03);
        --header-bg: linear-gradient(90deg, #0e3a5a, #2f6fbf);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
        -webkit-font-smoothing: antialiased;
        background: linear-gradient(180deg, #061014 0%, #07161a 60%);
        color: #eaf6ff;
        overflow-x: hidden;
      }

      /* FULLSCREEN LOADER */
      .loader-backdrop {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        background: linear-gradient(
          180deg,
          rgba(2, 6, 8, 0.75),
          rgba(2, 6, 8, 0.85)
        );
        transition: opacity 0.4s ease, visibility 0.4s;
      }
      .loader-inner {
        text-align: center;
        color: #e8fbff;
        padding: 28px;
        border-radius: 14px;
        width: 520px;
        max-width: 92%;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.04);
        box-shadow: 0 18px 52px rgba(0, 0, 0, 0.6);
      }
      .loader-title {
        font-weight: 800;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .loader-sub {
        color: var(--muted);
        margin-bottom: 18px;
      }
      .ellipsis {
        font-weight: 700;
        letter-spacing: 2px;
      }
      .dots {
        display: inline-block;
        width: 20px;
        text-align: left;
        margin-left: 8px;
      }
      .dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #e8fbff;
        border-radius: 50%;
        margin: 0 2px;
        opacity: 0.12;
        transform: translateY(0);
        animation: dots 1s infinite linear;
      }
      .dots span:nth-child(2) {
        animation-delay: 0.12s;
      }
      .dots span:nth-child(3) {
        animation-delay: 0.24s;
      }
      @keyframes dots {
        0% {
          opacity: 0.12;
          transform: translateY(0);
        }
        50% {
          opacity: 1;
          transform: translateY(-8px);
        }
        100% {
          opacity: 0.12;
          transform: translateY(0);
        }
      }

      .loader-spinner {
        width: 62px;
        height: 62px;
        margin: 10px auto 0;
        border-radius: 50%;
        border: 6px solid rgba(255, 255, 255, 0.06);
        border-top-color: var(--accent);
        animation: spin 1.1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loader-hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* Header */
      .header-wrap {
        background: linear-gradient(90deg, #0b2f52, #1a5fa7);
        padding: 12px 0;
        box-shadow: 0 6px 22px rgba(0, 0, 0, 0.45);
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        position: sticky;
        top: 0;
        z-index: 60;
      }
      .topbar-inner {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 0 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .left-area {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo-badge {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(180deg, #f6fbfb, #e8f7f7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        font-weight: 800;
        font-size: 16px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.22);
      }
      .brand-title {
        color: #f2fcff;
        font-weight: 800;
        font-size: 18px;
        letter-spacing: 0.2px;
        line-height: 1;
      }
      .brand-sub {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 2px;
      }

      /* Sort block */
      .sort-block {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 6px;
        color: #eaf6ff;
      }
      .sort-label {
        font-size: 12px;
        opacity: 0.9;
      }
      .sort-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.03);
        padding: 6px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .sort-btn {
        padding: 8px 12px;
        border-radius: 999px;
        background: transparent;
        border: none;
        color: #eaf6ff;
        cursor: pointer;
        font-weight: 700;
      }
      .sort-btn.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #072827;
        box-shadow: 0 8px 18px rgba(6, 58, 52, 0.16);
      }
      .sort-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        transition: transform 0.36s cubic-bezier(0.2, 0.9, 0.3, 1);
      }
      .sort-icon.rotated {
        transform: rotate(180deg);
      }

      /* search area */
      .controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .search-column {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end;
      }
      .search-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .search-input {
        background: var(--search-bg);
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #eaf6ff;
        padding: 10px 14px;
        border-radius: 12px;
        min-width: 420px;
        outline: none;
        font-size: 14px;
        transition: box-shadow 0.18s;
      }
      .search-input::placeholder {
        color: rgba(255, 255, 255, 0.28);
      }
      .search-input:focus {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      }

      .search-hint {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.75);
        margin-right: 6px;
        text-align: right;
        max-width: 420px;
      }

      @media (max-width: 1120px) {
        .search-input {
          min-width: 260px;
        }
      }
      @media (max-width: 520px) {
        .search-input {
          min-width: 140px;
        }
        .search-hint {
          text-align: left;
          max-width: 220px;
        }
      }

      /* Main */
      .wrap {
        max-width: var(--max-width);
        margin: 22px auto;
        padding: 0 18px;
      }

      /* grid: 2 columns desktop, 1 column below 1000px */
      .grid {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(2, 1fr);
        align-items: start;
        padding-bottom: 60px;
      }
      @media (max-width: 1000px) {
        .grid {
          grid-template-columns: repeat(1, 1fr);
        }
        :root {
          --thumb-size: 120px;
        }
      }
      @media (max-width: 520px) {
        :root {
          --thumb-size: 96px;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.015),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 12px;
        padding: 18px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.55);
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 420px;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 26px 66px rgba(0, 0, 0, 0.65);
      }

      .card-top {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .qr-badge {
        width: 54px;
        height: 54px;
        border-radius: 10px;
        background: linear-gradient(180deg, #f5fcfc, #e7f7f7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        font-weight: 800;
        font-size: 16px;
        flex-shrink: 0;
      }
      .head-right {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .title-wrap {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }
      .title {
        font-weight: 600;
        color: #d6eefc;
        font-size: 13px;
      }
      .invoice {
        font-weight: 900;
        font-size: 16px;
        color: #fff;
      }

      .meta-row {
        display: flex;
        gap: 14px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .meta-item {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 13px;
      }
      .meta-strong {
        font-weight: 800;
        color: #eef9ff;
        font-size: 14px;
      }

      .card-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .label {
        color: var(--muted);
        width: 150px;
        flex: 0 0 150px;
        font-size: 13px;
      }
      .value {
        flex: 1;
        font-weight: 700;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .chip {
        background: rgba(255, 255, 255, 0.03);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        color: #dfeefc;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }

      /* thumbs: always show 6 uniform square slots (2 columns x 3 rows) */
      .thumbs {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-content: start;
        width: 100%;
      }
      .thumb {
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.02)
        );
        display: block;
        width: 100%;
        aspect-ratio: 1 / 1;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
        border: 2px solid rgba(255, 255, 255, 0.02);
        position: relative;
        background-color: rgba(255, 255, 255, 0.01);
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        vertical-align: middle;
      }
      .thumb .fallback {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 14px;
        color: var(--muted);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.35),
          rgba(0, 0, 0, 0.35)
        );
        padding: 10px;
        border-radius: 10px;
        display: none;
      }
      .thumb:hover {
        transform: scale(1.04);
        box-shadow: 0 22px 52px rgba(0, 0, 0, 0.65);
        filter: brightness(1.02) saturate(1.03);
        z-index: 40;
      }

      .pill {
        padding: 8px 16px;
        border-radius: 999px;
        font-weight: 800;
        color: white;
        display: inline-block;
      }
      .pill.done {
        background: linear-gradient(180deg, #16a34a, #0ea25a);
      }
      .pill.pending {
        background: linear-gradient(180deg, #ef4444, #ef6b6b);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.86);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 60;
        padding: 18px;
      }
      .modal {
        background: linear-gradient(180deg, #071618, #0a1718);
        border-radius: 12px;
        padding: 18px;
        max-width: 920px;
        width: 100%;
        max-height: 90vh;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .modal-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }
      .modal-img {
        width: 100%;
        max-height: 72vh;
        object-fit: contain;
        border-radius: 10px;
      }
      .links-list {
        margin-top: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
      .link-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.02);
        padding: 10px 14px;
        border-radius: 10px;
        width: 100%;
        max-width: 820px;
      }
      .link-row a {
        color: #cfe9ff;
        text-decoration: underline;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <!-- LOADER (shows first) -->
    <div id="loaderBackdrop" class="loader-backdrop">
      <div class="loader-inner" role="status" aria-live="polite">
        <div class="loader-title">
          Tracking your QR <span style="opacity: 0.9">........</span>
        </div>
        <div class="loader-sub">
          Preparing your tracking cards — this may take a moment
        </div>

        <div
          style="
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          "
        >
          <div class="loader-spinner" aria-hidden="true"></div>
        </div>

        <div style="margin-top: 14px; font-weight: 600">
          <span class="ellipsis">Tracking your QR</span>
          <span class="dots" aria-hidden="true"
            ><span></span><span></span><span></span
          ></span>
        </div>
      </div>
    </div>

    <!-- HEADER -->
    <header class="header-wrap">
      <div class="topbar-inner">
        <div style="display: flex; align-items: center; gap: 12px">
          <div class="brand" aria-hidden="false">
            <div class="logo-badge">QR</div>
            <div>
              <div class="brand-title">QR Code Tracker</div>
              <div class="brand-sub">Shipment QR tracking — Card view</div>
            </div>
          </div>

          <div class="sort-block" aria-hidden="false">
            <div class="sort-label">Sort</div>
            <div class="sort-toggle" role="radiogroup" aria-label="Sort cards">
              <div id="sortIcon" class="sort-icon" title="Sort order icon">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M6 9l6 6 6-6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  ></path>
                </svg>
              </div>
              <button
                class="sort-btn active"
                id="sortNewest"
                data-val="desc"
                aria-pressed="true"
              >
                Newest
              </button>
              <button
                class="sort-btn"
                id="sortOldest"
                data-val="asc"
                aria-pressed="false"
              >
                Oldest
              </button>
            </div>
          </div>
        </div>

        <div class="controls" role="search" aria-label="Search and controls">
          <div class="search-column">
            <div class="search-row">
              <input
                id="searchInput"
                class="search-input"
                placeholder="Search invoice, location, date, month (jan / january) or batch..."
                aria-label="Search cards"
              />
            </div>
            <div class="search-hint" id="searchHint">
              Try: <strong>jan</strong>, <strong>January</strong>,
              <strong>nov 2025</strong>, or invoice like
              <strong>INV-1029</strong>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN GRID -->
    <main class="wrap">
      <section id="grid" class="grid" aria-live="polite"></section>
    </main>

    <!-- Modal -->
    <div
      id="modalBackdrop"
      class="modal-backdrop"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-top">
          <div>
            <div
              id="modalTitle"
              style="font-weight: 800; font-size: 16px; color: #e9f8ff"
            ></div>
            <div style="color: var(--muted); font-size: 13px">
              Links for this QR (click to open or copy)
            </div>
          </div>
          <div>
            <button
              id="modalClose"
              style="
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.06);
                padding: 8px 12px;
                border-radius: 8px;
                color: #e6eef8;
                cursor: pointer;
              "
            >
              Close
            </button>
          </div>
        </div>

        <div>
          <img id="modalImage" class="modal-img" src="" alt="QR large view" />
        </div>
        <div id="modalLinks" class="links-list"></div>
      </div>
    </div>

    <script>
      // show loader for 4.5s then init app
      const loader = document.getElementById("loaderBackdrop");
      const LOADER_MS = 4500; // 4.5 seconds

      // local image path you provided earlier (use to replace broken placeholder)
      const LOCAL_QR = "/mnt/data/798a63fe-c787-4bc6-91c1-b50b87613e46.png";

      // cards dataset (kept previous + 6 new)
      const cards = [
        {
          id: 1,
          invoice: "INV-1001",
          date: "2025-11-10",
          location: "Mumbai Port",
          status: "completed",
          batches: ["MB-211", "MB-212", "MB-300A"],
          qrImages: [
            { url: "qr-1-0", links: [] },
            { url: LOCAL_QR, links: ["https://example.com/qr/1001-2"] },
          ],
        },
        {
          id: 2,
          invoice: "INV-1023",
          date: "2025-11-18",
          location: "Nhava Sheva",
          status: "pending",
          batches: ["MB-900"],
          qrImages: [],
        },
        {
          id: 3,
          invoice: "INV-1029",
          date: "2025-11-21",
          location: "Tuticorin",
          status: "completed",
          batches: ["MB-111", "MB-112", "MB-113", "MB-114"],
          qrImages: [
            {
              url: "https://picsum.photos/id/1020/600/400",
              links: ["https://example.com/qr/1029"],
            },
            { url: "https://picsum.photos/id/1024/600/400", links: [] },
            { url: "https://picsum.photos/id/1025/600/400", links: [] },
          ],
        },
        {
          id: 4,
          invoice: "INV-1035",
          date: "2025-11-22",
          location: "Chennai Port",
          status: "pending",
          batches: ["MB-201"],
          qrImages: [
            { url: "https://picsum.photos/id/1015/600/400", links: [] },
            { url: "https://picsum.photos/id/1016/600/400", links: [] },
          ],
        },
        {
          id: 5,
          invoice: "INV-1040",
          date: "2025-11-23",
          location: "Kolkata Port",
          status: "completed",
          batches: ["MB-301", "MB-302"],
          qrImages: [
            { url: "https://picsum.photos/id/1005/600/400", links: [] },
            { url: "https://picsum.photos/id/1011/600/400", links: [] },
          ],
        },
        {
          id: 6,
          invoice: "INV-1045",
          date: "2025-11-24",
          location: "Cochin Port",
          status: "pending",
          batches: ["MB-401", "MB-402", "MB-403"],
          qrImages: [],
        },

        // 6 new cards
        {
          id: 7,
          invoice: "INV-1050",
          date: "2025-11-25",
          location: "Vizag Port",
          status: "completed",
          batches: ["MB-501"],
          qrImages: [
            {
              url: "https://picsum.photos/id/1036/600/400",
              links: ["https://example.com/qr/1050-a"],
            },
            { url: "https://picsum.photos/id/1037/600/400", links: [] },
          ],
        },
        {
          id: 8,
          invoice: "INV-1051",
          date: "2025-12-02",
          location: "Mangalore",
          status: "pending",
          batches: ["MB-502", "MB-503"],
          qrImages: [
            { url: LOCAL_QR, links: ["https://example.com/qr/1051-1"] },
            { url: "bad-path", links: [] },
          ],
        },
        {
          id: 9,
          invoice: "INV-1052",
          date: "2025-12-10",
          location: "Kandla Port",
          status: "completed",
          batches: ["MB-510", "MB-511", "MB-512"],
          qrImages: [
            { url: "https://picsum.photos/id/1040/600/400", links: [] },
            { url: "https://picsum.photos/id/1041/600/400", links: [] },
            { url: "https://picsum.photos/id/1042/600/400", links: [] },
          ],
        },
        {
          id: 10,
          invoice: "INV-1053",
          date: "2026-01-05",
          location: "Nhava Sheva",
          status: "pending",
          batches: ["MB-600"],
          qrImages: [],
        },
        {
          id: 11,
          invoice: "INV-1054",
          date: "2026-01-18",
          location: "Mumbai Port",
          status: "completed",
          batches: ["MB-610", "MB-611"],
          qrImages: [
            {
              url: "https://picsum.photos/id/1050/600/400",
              links: ["https://example.com/qr/1054"],
            },
            { url: "https://picsum.photos/id/1051/600/400", links: [] },
            { url: "https://picsum.photos/id/1052/600/400", links: [] },
          ],
        },
        {
          id: 12,
          invoice: "INV-1055",
          date: "2026-02-02",
          location: "Tuticorin",
          status: "pending",
          batches: ["MB-700"],
          qrImages: [
            { url: "https://picsum.photos/id/1060/600/400", links: [] },
          ],
        },
      ];

      // DOM refs
      const grid = document.getElementById("grid");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalImage = document.getElementById("modalImage");
      const modalLinks = document.getElementById("modalLinks");
      const modalTitle = document.getElementById("modalTitle");
      const searchInput = document.getElementById("searchInput");
      const sortNewest = document.getElementById("sortNewest");
      const sortOldest = document.getElementById("sortOldest");
      const sortIcon = document.getElementById("sortIcon");

      document
        .getElementById("modalClose")
        .addEventListener("click", closeModal);

      // month map for searching
      const monthMap = {
        jan: 0,
        january: 0,
        feb: 1,
        february: 1,
        mar: 2,
        march: 2,
        apr: 3,
        april: 3,
        may: 4,
        jun: 5,
        june: 5,
        jul: 6,
        july: 6,
        aug: 7,
        august: 7,
        sep: 8,
        sept: 8,
        september: 8,
        oct: 9,
        october: 9,
        nov: 10,
        november: 10,
        dec: 11,
        december: 11,
      };

      function parseDate(d) {
        const t = new Date(d);
        return isNaN(t) ? null : t;
      }
      function sortCardsByDate(list, mode = "desc") {
        return [...list].sort((a, b) => {
          const da = parseDate(a.date)?.getTime() || 0;
          const db = parseDate(b.date)?.getTime() || 0;
          return mode === "asc" ? da - db : db - da;
        });
      }

      function filterCards(list, q) {
        if (!q) return list;
        const s = q.trim().toLowerCase();
        const parts = s.split(/\s+/).filter(Boolean);
        if (parts.length === 1 && monthMap[parts[0]] !== undefined) {
          const m = monthMap[parts[0]];
          return list.filter((c) => {
            const d = parseDate(c.date);
            return d && d.getMonth() === m;
          });
        }
        if (parts.length >= 2 && monthMap[parts[0]] !== undefined) {
          const m = monthMap[parts[0]];
          const yr = Number(parts[1]);
          if (!isNaN(yr))
            return list.filter((c) => {
              const d = parseDate(c.date);
              return d && d.getMonth() === m && d.getFullYear() === yr;
            });
        }
        return list.filter((c) => {
          if (
            String(c.invoice || "")
              .toLowerCase()
              .includes(s)
          )
            return true;
          if (
            String(c.location || "")
              .toLowerCase()
              .includes(s)
          )
            return true;
          if (
            String(c.date || "")
              .toLowerCase()
              .includes(s)
          )
            return true;
          if (
            (c.batches || []).some((b) =>
              String(b || "")
                .toLowerCase()
                .includes(s)
            )
          )
            return true;
          if (
            (c.qrImages || []).some((img) =>
              (img.links || []).some((l) => String(l).toLowerCase().includes(s))
            )
          )
            return true;
          return false;
        });
      }

      function debounce(fn, wait = 180) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), wait);
        };
      }

      function renderSixSlots(card) {
        const slots = 6;
        const arr = card.qrImages || [];
        const result = [];
        for (let i = 0; i < slots; i++) {
          if (i < arr.length) {
            const img = arr[i];
            result.push(
              `<div class="thumb" data-card="${card.id}" data-index="${i}"><img src="${img.url}" alt="qr-${card.id}-${i}" loading="lazy" onerror="handleBroken(this)"><div class="fallback">Image not found</div></div>`
            );
          } else {
            result.push(
              `<div class="thumb" data-card="${card.id}" data-index="${i}" aria-hidden="true"><div class="fallback" style="display:flex">No image</div></div>`
            );
          }
        }
        return result.join("");
      }

      function render() {
        const query = searchInput.value || "";
        let list = sortCardsByDate(cards, sortOrder);
        list = filterCards(list, query);

        grid.innerHTML = "";
        list.forEach((card) => {
          const thumbsId = `thumbs-${card.id}`;
          const el = document.createElement("article");
          el.className = "card";
          el.innerHTML = `
        <div class="card-top">
          <div class="qr-badge">QR</div>
          <div class="head-right">
            <div class="title-wrap">
              <div class="title">Shipment Invoice#</div>
              <div class="invoice">${card.invoice}</div>
            </div>
            <div class="meta-row">
              <div class="meta-item">${calendarSVG()}<div style="display:flex;flex-direction:column"><div class="meta-strong">${
            card.date
          }</div><div style="color:var(--muted);font-size:12px;margin-top:4px">Container date</div></div></div>
              <div class="meta-item">${locationSVG()}<div style="display:flex;flex-direction:column"><div class="meta-strong">${
            card.location
          }</div><div style="color:var(--muted);font-size:12px;margin-top:4px">Port</div></div></div>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div class="row"><div class="label">Status</div><div class="value"><div class="pill ${
            card.status === "completed" ? "done" : "pending"
          }">${
            card.status === "completed" ? "Completed" : "Pending"
          }</div></div></div>

          <div class="row"><div class="label">Material Batch</div><div class="value chips">${(
            card.batches || []
          )
            .map((b) => `<span class="chip">${b}</span>`)
            .join("")}</div></div>

          <div class="row">
            <div class="label">QR Code(s)</div>
            <div class="value thumbs" id="${thumbsId}">
              ${renderSixSlots(card)}
            </div>
          </div>
        </div>
      `;
          grid.appendChild(el);

          // thumb click handlers
          document.querySelectorAll(`#${thumbsId} .thumb`).forEach((t) => {
            t.addEventListener("click", () => {
              const img = t.querySelector("img");
              if (img && img.dataset && img.dataset.broken === "true") {
                Swal.fire({
                  toast: true,
                  position: "top-end",
                  icon: "info",
                  title: "Image not available",
                  showConfirmButton: false,
                  timer: 900,
                });
                return;
              }
              const cardId = Number(t.getAttribute("data-card"));
              const idx = Number(t.getAttribute("data-index"));
              openModal(cardId, idx);
            });
          });
        });

        if (list.length === 0) {
          const empty = document.createElement("div");
          empty.style.padding = "36px";
          empty.style.gridColumn = "1 / -1";
          empty.style.color = "var(--muted)";
          empty.style.textAlign = "center";
          empty.textContent = "No cards match your search.";
          grid.appendChild(empty);
        }
      }

      function handleBroken(img) {
        try {
          img.dataset.broken = "true";
          img.style.display = "none";
          const parent = img.closest(".thumb");
          if (parent) {
            const fallback = parent.querySelector(".fallback");
            if (fallback) fallback.style.display = "flex";
          }
        } catch (e) {
          console.error(e);
        }
      }

      function openModal(cardId, imgIndex) {
        const card = cards.find((c) => c.id === cardId);
        if (!card) return;
        const imgObj = (card.qrImages || [])[imgIndex];
        if (!imgObj) return;
        modalImage.src = imgObj.url;
        modalTitle.textContent = `${card.invoice} — QR ${imgIndex + 1}`;
        modalLinks.innerHTML = "";
        const links = imgObj.links || [];
        if (links.length === 0) {
          const d = document.createElement("div");
          d.textContent = "No links attached to this QR";
          d.style.color = "var(--muted)";
          modalLinks.appendChild(d);
        } else {
          links.forEach((l) => {
            const row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML = `<a href="${l}" target="_blank" rel="noopener noreferrer">${l}</a><div style="margin-left:auto"><button class="copy-btn" data-link="${l}" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#e6eef8;cursor:pointer">Copy</button></div>`;
            modalLinks.appendChild(row);
          });
          modalLinks.querySelectorAll(".copy-btn").forEach((btn) =>
            btn.addEventListener("click", () => {
              navigator.clipboard
                .writeText(btn.dataset.link)
                .then(() =>
                  Swal.fire({
                    toast: true,
                    position: "top-end",
                    icon: "success",
                    title: "Copied",
                    showConfirmButton: false,
                    timer: 900,
                  })
                );
            })
          );
        }
        modalBackdrop.style.display = "flex";
        modalBackdrop.setAttribute("aria-hidden", "false");
        modalBackdrop.scrollIntoView({ behavior: "smooth", block: "center" });
      }
      function closeModal() {
        modalBackdrop.style.display = "none";
        modalBackdrop.setAttribute("aria-hidden", "true");
        modalImage.src = "";
        modalLinks.innerHTML = "";
      }

      function calendarSVG() {
        return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-opacity="0.9" stroke-width="1.6"></rect><path d="M16 3v4M8 3v4" stroke="currentColor" stroke-opacity="0.9" stroke-width="1.6" stroke-linecap="round"></path></svg>`;
      }
      function locationSVG() {
        return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 21s7-4.5 7-10a7 7 0 10-14 0c0 5.5 7 10 7 10z" stroke="currentColor" stroke-opacity="0.9" stroke-width="1.4" fill="rgba(255,255,255,0.02)"></path><circle cx="12" cy="11" r="2.4" fill="currentColor" fill-opacity="0.9"></circle></svg>`;
      }

      // search & sort wiring
      let sortOrder = "desc";
      const onSearch = debounce(() => render(), 180);
      searchInput.addEventListener("input", onSearch);

      sortNewest.addEventListener("click", () => {
        sortOrder = "desc";
        sortNewest.classList.add("active");
        sortNewest.setAttribute("aria-pressed", "true");
        sortOldest.classList.remove("active");
        sortOldest.setAttribute("aria-pressed", "false");
        sortIcon.classList.remove("rotated");
        render();
      });
      sortOldest.addEventListener("click", () => {
        sortOrder = "asc";
        sortOldest.classList.add("active");
        sortOldest.setAttribute("aria-pressed", "true");
        sortNewest.classList.remove("active");
        sortNewest.setAttribute("aria-pressed", "false");
        sortIcon.classList.add("rotated");
        render();
      });

      // initial load behavior
      window.addEventListener("load", () => {
        // show loader for LOADER_MS then fade & render
        setTimeout(() => {
          loader.classList.add("loader-hidden");
          setTimeout(() => (loader.style.display = "none"), 420);
          // after loader gone render UI
          render();
        }, LOADER_MS);
      });

      // close modal with esc
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalBackdrop.style.display === "flex")
          closeModal();
      });
    </script>
  </body>
</html>
